steps:
# Enable "down for maintenance" by setting route pattern to emailapi.io
- name: Cloudflare Workers route update
  uses: aakashlpin/cloudflare-worker-route-update@v0.5
  with:
    CF_EMAIL: ${{ secrets.CF_EMAIL }}
    CF_API_KEY: ${{ secrets.CF_API_KEY}}
    CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
    CF_ROUTE_ID: ${{ secrets.CF_ROUTE_ID }}
    CF_WORKER_NAME: ${{ secrets.CF_WORKER_NAME }}
    CF_ROUTE_PATTERN: 'ifixtech.ca/*'

# restart the docker server on remote machine
- name: Remote Start docker server
  uses: appleboy/ssh-action@master
  env:
    GITBUH_USERNAME: ${{ secrets.GITBUH_USERNAME }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    host: ${{ secrets.DO_HOST }}
    username: ${{ secrets.DO_USERNAME }}
    key: ${{ secrets.SSH_ID_RSA }}
    envs: GITBUH_USERNAME, GITHUB_TOKEN
    script: |
      docker stop emailapi_app
      docker rm emailapi_app
      docker run -dit --rm --env-file ~/apps/emailapi-pipeline/.env -p 3000:3000 -v /tmp:/tmp --name emailapi_app docker.pkg.github.com/aakashlpin/emailapi/emailapi:latest
# Remove "down for maintenance" page by setting route pattern to away.emailapi.io
- name: Cloudflare Workers route update
  uses: aakashlpin/cloudflare-worker-route-update@v0.5
  with:
    CF_EMAIL: ${{ secrets.CF_EMAIL }}
    CF_API_KEY: ${{ secrets.CF_API_KEY}}
    CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
    CF_ROUTE_ID: ${{ secrets.CF_ROUTE_ID }}
    CF_WORKER_NAME: ${{ secrets.CF_WORKER_NAME }}
    CF_ROUTE_PATTERN: 'maintenance.ifixtech.ca/*'
